<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Havenvoy</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="loading-screen"><div class="loading-content"><h1>Havenvoy</h1><div class="loading-ship">â›µ</div><p>Charting the waters...</p><div class="loading-bar"><div class="loading-progress"></div></div></div></div>
<div id="error-overlay" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.9);color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10000;padding:20px;text-align:center;">
    <div style="font-size:3rem;margin-bottom:1rem;">âš ï¸</div>
    <h2 style="margin:0 0 1rem;color:#f44;">Something went wrong</h2>
    <p id="error-message" style="margin:0 0 1rem;max-width:500px;opacity:0.8;font-size:0.9rem;">An error occurred while loading the game.</p>
    <pre id="error-details" style="background:#1a1a1a;padding:10px;border-radius:4px;max-width:90%;overflow:auto;font-size:0.75rem;text-align:left;margin:0 0 1rem;"></pre>
    <button onclick="location.reload()" style="background:#4a7c59;color:#fff;border:none;padding:12px 24px;border-radius:6px;font-size:1rem;cursor:pointer;">ğŸ”„ Reload Game</button>
</div>
<div id="faction-screen" class="screen hidden">
    <div class="screen-content">
        <h1>Choose Your Allegiance</h1>
        <p class="subtitle">Your faction determines advantages and difficulty</p>
        <div class="faction-cards">
            <button class="faction-card" data-faction="english"><div class="faction-icon">ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿</div><h2>Royal Navy</h2><span class="difficulty-tag difficulty-easy">Easy</span><p class="faction-desc">Servants of the Crown</p><ul class="faction-perks"><li>âœ¦ +25 Starting Reputation</li><li>âœ¦ 50% Less Pirate Encounters</li><li>âœ¦ Cheaper Tribute</li></ul></button>
            <button class="faction-card" data-faction="eitc"><div class="faction-icon">âš“</div><h2>Trading Company</h2><span class="difficulty-tag difficulty-medium">Medium</span><p class="faction-desc">Profit Above All</p><ul class="faction-perks"><li>âœ¦ +20% Cargo Capacity</li><li>âœ¦ Better Trade Prices</li><li>âœ¦ Enhanced Logbook Intel</li></ul></button>
            <button class="faction-card" data-faction="pirates"><div class="faction-icon">ğŸ´â€â˜ ï¸</div><h2>Brethren Court</h2><span class="difficulty-tag difficulty-hard">Hard</span><p class="faction-desc">Freedom of the Seas</p><ul class="faction-perks"><li>âœ¦ Contraband +50%</li><li>âœ¦ Faster Speed</li><li>âœ¦ More Encounters</li></ul></button>
        </div>
        <button id="continue-btn" class="btn-primary hidden">Set Sail</button>
    </div>
</div>

<div id="game-container" class="hidden">
    <canvas id="game-canvas"></canvas>
    <div id="hud-top">
        <div class="hud-item"><span class="hud-icon">ğŸª™</span><span class="hud-value" id="gold-value">1000</span></div>
        <div class="hud-item"><span class="hud-icon">ğŸ“…</span><span class="hud-value">Day <span id="day-value">1</span></span></div>
        <div class="hud-item"><span class="hud-icon">ğŸ–</span><span class="hud-value" id="supplies-value">30</span></div>
    </div>
    <div id="faction-badge"><span id="faction-icon">ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿</span><span id="faction-name">Royal Navy</span></div>
    <div id="cargo-summary"><div class="cargo-header"><span>ğŸ“¦ Cargo</span><span id="cargo-count">0/50</span></div><div id="cargo-preview"></div></div>
    <div id="wind-indicator"><span id="wind-arrow">ğŸ’¨</span><span id="wind-strength">Calm</span></div>
    <div id="heat-indicator" class="low"><span>ğŸ”¥</span><div class="heat-bar"><div class="heat-fill" id="heat-fill"></div></div><span id="heat-label">0</span></div>
    <div id="bounty-indicator" class="clean"><span>âš–ï¸</span><span id="bounty-level">Clean</span></div>
    <div id="notoriety-indicator" title="How predictable your trading patterns have become"><span>ğŸ‘ï¸</span><div class="notoriety-bar"><div class="notoriety-fill" id="notoriety-fill"></div></div><span id="notoriety-label">Unseen</span></div>
    <div id="contract-tracker" class="hidden"><span>ğŸ“œ</span><span class="contract-title" id="tracker-title">--</span><span class="contract-meta" id="tracker-meta">--</span></div>
    <div id="world-indicator"><span id="world-icon">ğŸŒ¤ï¸</span><span id="world-status">Fair Winds</span></div>
    <div id="ship-condition">
        <div class="ship-class-name"><span id="ship-class-icon">â›µ</span><span id="ship-class-label">Brigantine</span></div>
        <div class="condition-row"><span class="condition-icon" title="Hull integrity">ğŸªµ</span><div class="condition-bar"><div class="condition-fill hull" id="hull-fill"></div></div><span class="condition-value" id="hull-value">100</span></div>
        <div class="condition-row"><span class="condition-icon" title="Rigging condition">ğŸª¢</span><div class="condition-bar"><div class="condition-fill rigging" id="rigging-fill"></div></div><span class="condition-value" id="rigging-value">100</span></div>
        <div class="condition-row"><span class="condition-icon" title="Crew morale">ğŸ‘¥</span><div class="condition-bar"><div class="condition-fill morale" id="morale-fill"></div></div><span class="condition-value" id="morale-value">100</span></div>
    </div>
    <div id="chart-fragments" class="chart-fragment-indicator hidden"><span>ğŸ—ºï¸</span><span id="fragments-count">0</span>/3</div>
    <div id="compass">
        <div class="compass-ring">
            <div class="compass-needle" id="compass-needle"></div>
            <div class="compass-dest-marker hidden" id="compass-dest-marker"></div>
            <span class="compass-n">N</span><span class="compass-e">E</span><span class="compass-s">S</span><span class="compass-w">W</span>
        </div>
        <div id="destination-info" class="hidden"><span id="dest-name">--</span><span id="dest-distance">--</span></div>
    </div>
    <div id="event-toast" class="hidden"><div class="event-icon">âš¡</div><div class="event-text"><strong id="event-title">Event</strong><span id="event-desc">Description</span></div></div>
    <div id="mobile-controls">
        <div id="joystick-zone"><div id="joystick-base"></div><div id="joystick-stick"></div></div>
        <div id="speed-indicator"><span>â›µ</span><div class="bar"><div class="bar-fill" id="speed-fill"></div></div><span id="wind-effect"></span></div>
        <div id="island-indicator"><div class="name" id="nearby-island-name">Port Royal</div><div class="faction" id="nearby-island-faction">English</div><div class="distance" id="nearby-island-dist">Nearby</div></div>
        <div id="action-buttons">
            <button class="action-btn" id="btn-dock">âš“</button>
            <button class="action-btn" id="btn-map">ğŸ—ºï¸</button>
            <button class="action-btn" id="btn-menu">â˜°</button>
        </div>
    </div>
</div>

<div id="trade-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header"><h2 id="trade-island-name">Port Royal</h2><div class="island-info"><span id="trade-island-faction" class="faction-tag">English</span><span id="trade-tariff" class="tariff-tag">No Tariff</span><span id="trade-port-state" class="port-state-tag hidden">Prosperous</span></div><button class="modal-close" id="close-trade">âœ•</button></div>
        <div class="trade-tabs">
            <button class="trade-tab active" data-tab="buy">Buy</button>
            <button class="trade-tab" data-tab="sell">Sell</button>
            <button class="trade-tab" data-tab="contracts">ğŸ“œ Jobs<span class="tab-badge hidden" id="contracts-badge">0</span></button>
            <button class="trade-tab" data-tab="tavern">ğŸº Tavern</button>
            <button class="trade-tab" data-tab="logbook">ğŸ“– Log</button>
            <button class="trade-tab" data-tab="shipyard">ğŸ”§ Ship</button>
        </div>
        <div class="trade-panel" id="buy-panel"><div class="panel-actions"><button class="btn-secondary btn-small" id="buy-best-btn">ğŸ’° Buy Best</button></div><div class="goods-list" id="buy-goods-list"></div></div>
        <div class="trade-panel hidden" id="sell-panel"><div class="panel-actions"><button class="btn-secondary btn-small" id="sell-best-btn">ğŸ’° Sell Best</button></div><div class="goods-list" id="sell-goods-list"></div></div>
        <div class="trade-panel hidden" id="contracts-panel"><div class="logbook-section" id="questline-section"><h4>ğŸ“œ Questlines</h4><div id="questline-content"></div></div><div class="logbook-section"><h4>ğŸ“‹ Available Contracts</h4><div id="available-contracts"></div></div><div class="logbook-section"><h4>ğŸ“Œ Active Contracts (<span id="active-count">0</span>/3)</h4><div id="active-contracts"></div></div></div>
        <div class="trade-panel hidden" id="tavern-panel"><div class="logbook-section"><h4>ğŸ‘¥ Your Officers (<span id="officer-count">0</span>/3)</h4><div id="current-officers"></div></div><div class="logbook-section"><h4>ğŸ» Available for Hire</h4><div id="available-officers"></div></div><div class="logbook-section"><h4>ğŸ—£ï¸ Port Rumors</h4><div id="tavern-rumors"></div></div></div>
        <div class="trade-panel hidden" id="logbook-panel"><div class="logbook-section"><h4>ğŸ’¡ Deal Spotlight</h4><div id="spotlight-list"></div></div><div class="logbook-section"><h4>ğŸ“œ Price History</h4><select class="island-select" id="logbook-island-select"></select><div id="logbook-prices"></div></div></div>
        <div class="trade-panel hidden" id="shipyard-panel"><div id="upgrades-list"></div></div>
        <div class="trade-footer"><div class="player-stats"><span>ğŸª™ <span id="trade-gold">1000</span></span><span>ğŸ“¦ <span id="trade-cargo">0/50</span></span></div><button class="btn-primary" id="leave-port-btn">Set Sail</button></div>
    </div>
</div>

<div id="map-modal" class="modal hidden">
    <div class="modal-content map-content">
        <h2>Navigation Chart</h2>
        <div id="map-container"></div>
        <div class="map-info" id="map-info">Click island to set course</div>
        <div class="map-legend"><span><div class="legend-dot" style="background:var(--english)"></div>English</span><span><div class="legend-dot" style="background:var(--eitc)"></div>EITC</span><span><div class="legend-dot" style="background:var(--pirates)"></div>Pirates</span><span><div class="legend-dot" style="background:var(--neutral)"></div>Neutral</span></div>
        <div class="map-buttons"><button class="btn-secondary" id="clear-course-btn">Clear Course</button><button class="btn-primary" id="close-map">Close</button></div>
    </div>
</div>

<div id="cove-modal" class="modal hidden">
    <div class="modal-content cove-modal-content">
        <div class="cove-icon" id="cove-icon">ğŸ´â€â˜ ï¸</div>
        <h2 id="cove-name">Hidden Cove</h2>
        <p class="cove-desc" id="cove-desc">A hidden location known only to a few...</p>
        <div class="cove-services" id="cove-services"></div>
        <button class="btn-secondary" id="close-cove" style="margin-top: var(--space-md);">Leave</button>
    </div>
</div>

<div id="menu-modal" class="modal hidden">
    <div class="modal-content menu-content">
        <h2>Captain's Log</h2>
        <div class="menu-section"><h3>Reputation</h3><div class="reputation-bars"><div class="rep-item"><span>ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ Navy</span><div class="rep-bar"><div class="rep-fill" id="rep-english"></div></div><span class="rep-value" id="rep-english-val">0</span></div><div class="rep-item"><span>âš“ EITC</span><div class="rep-bar"><div class="rep-fill" id="rep-eitc"></div></div><span class="rep-value" id="rep-eitc-val">0</span></div><div class="rep-item"><span>ğŸ´â€â˜ ï¸ Pirates</span><div class="rep-bar"><div class="rep-fill" id="rep-pirates"></div></div><span class="rep-value" id="rep-pirates-val">0</span></div></div></div>
        <div class="menu-section"><h3>Titles</h3><div id="titles-list"></div></div>
        <div class="menu-section"><h3>World Status</h3><div class="ship-stats"><div class="stat-row"><span>Season</span><span id="menu-season">Fair</span></div><div class="stat-row"><span>Crackdown</span><span id="menu-crackdown">None</span></div><div class="stat-row"><span>Regional Event</span><span id="menu-regional">None</span></div></div></div>
        <div class="menu-section"><h3>Ship</h3><div class="ship-stats"><div class="stat-row"><span>Speed</span><span id="ship-speed">1.0x</span></div><div class="stat-row"><span>Cargo</span><span id="ship-cargo-cap">50</span></div><div class="stat-row"><span>Supply/Day</span><span id="ship-supply-rate">1</span></div><div class="stat-row"><span>Upgrades</span><span id="ship-upgrades">None</span></div></div></div>
        <div class="menu-section"><h3>Wind & Risk</h3><div class="ship-stats"><div class="stat-row"><span>Wind</span><span id="menu-wind-dir">N Calm</span></div><div class="stat-row"><span>Wind Change</span><span id="menu-wind-change">5d</span></div><div class="stat-row"><span>Route Risk</span><span id="menu-route-risk">Low</span></div><div class="stat-row"><span>Heat</span><span id="menu-heat">0</span></div></div></div>
        <div class="menu-buttons"><button class="btn-secondary" id="save-btn">ğŸ’¾ Save</button><button class="btn-secondary" id="new-game-btn">ğŸ”„ New Game</button></div>
        <button class="btn-primary" id="close-menu">Continue</button>
    </div>
</div>

<div id="pirate-modal" class="modal hidden"><div class="modal-content pirate-content"><div class="pirate-icon">ğŸ´â€â˜ ï¸</div><h2>Pirates!</h2><p>They demand tribute!</p><div class="pirate-options"><button class="btn-danger" id="pay-tribute">ğŸ’° Pay <small id="tribute-cost">100g</small></button><button class="btn-secondary" id="fight-pirates">âš”ï¸ Fight</button><button class="btn-primary hidden" id="pirate-pass">ğŸ´â€â˜ ï¸ Parley</button></div></div></div>

<div id="chase-modal" class="modal hidden">
    <div class="modal-content chase-content">
        <div class="chase-header">
            <span class="chase-icon">ğŸ´â€â˜ ï¸</span>
            <h2>Pirates Spotted!</h2>
        </div>
        <p class="chase-desc" id="chase-desc">A pirate ship is giving chase! Try to escape!</p>
        <div class="chase-progress">
            <div class="chase-bar">
                <div class="chase-player" id="chase-player">â›µ</div>
                <div class="chase-pirate" id="chase-pirate">ğŸ´â€â˜ ï¸</div>
            </div>
            <div class="chase-labels">
                <span>Escape</span>
                <span>Caught</span>
            </div>
        </div>
        <div class="chase-stats">
            <div class="chase-stat"><span>Escape Chance:</span><span id="chase-chance">50%</span></div>
            <div class="chase-stat"><span>Time Left:</span><span id="chase-timer">15s</span></div>
        </div>
        <div class="chase-actions">
            <button class="btn-primary chase-action" id="chase-trim">ğŸª¢ Trim Sails</button>
            <button class="btn-secondary chase-action" id="chase-jettison">ğŸ“¦ Jettison Cargo</button>
            <button class="btn-danger chase-action" id="chase-risky">âš¡ Risky Maneuver</button>
        </div>
        <div class="chase-result hidden" id="chase-result"></div>
    </div>
</div>

<div id="encounter-modal" class="modal hidden"><div class="modal-content encounter-content"><div class="encounter-icon" id="encounter-icon">ğŸŒŠ</div><h2 id="encounter-title">Event</h2><p id="encounter-desc">Description</p><div id="encounter-result"></div><div class="encounter-options" id="encounter-options"></div></div></div>

<div id="warning-modal" class="modal hidden"><div class="modal-content warning-content"><div class="warning-icon" id="warning-icon">âš ï¸</div><h2 id="warning-title">Warning</h2><p id="warning-text">Message</p><button class="btn-primary" id="warning-dismiss">Continue</button></div></div>

<div id="title-modal" class="modal hidden"><div class="modal-content warning-content"><div class="warning-icon" id="title-icon">ğŸ†</div><h2 id="title-earned-name">Title Earned!</h2><p id="title-earned-desc">You have proven yourself worthy.</p><button class="btn-primary" id="title-dismiss">Continue</button></div></div>

<div id="contract-complete-modal" class="modal hidden"><div class="modal-content warning-content"><div class="warning-icon" id="contract-complete-icon">ğŸ“œ</div><h2 id="contract-complete-title">Contract Complete!</h2><p id="contract-complete-desc">You've fulfilled the contract.</p><div id="contract-complete-rewards"></div><button class="btn-primary" id="contract-complete-dismiss">Collect Rewards</button></div></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
// Error overlay display function
function showErrorOverlay(message, details) {
    var overlay = document.getElementById('error-overlay');
    var msgEl = document.getElementById('error-message');
    var detailsEl = document.getElementById('error-details');
    if (overlay && msgEl && detailsEl) {
        msgEl.textContent = message || 'An error occurred while loading the game.';
        detailsEl.textContent = details || '';
        overlay.classList.remove('hidden');
        document.getElementById('loading-screen')?.classList.add('hidden');
    }
}

// NON-MODULE FALLBACK - runs even if module fails to load
window.onerror = function(msg, url, line, col, error) {
    console.error('Script error:', msg, url, line);
    var details = 'Error: ' + msg + '\nLocation: ' + (url || 'unknown') + ':' + (line || '?');
    if (error && error.stack) details += '\n\nStack:\n' + error.stack;
    showErrorOverlay('A script error occurred. Try refreshing the page.', details);
    return false;
};

// Catch module import errors
window.addEventListener('unhandledrejection', function(event) {
    console.error('Module error:', event.reason);
    var details = event.reason ? (event.reason.message || String(event.reason)) : 'Unknown module error';
    if (event.reason && event.reason.stack) details += '\n\nStack:\n' + event.reason.stack;
    showErrorOverlay('Failed to load a required module. Check your network connection.', details);
});

// Fallback timeout - if loading screen still showing after 15 seconds, something is wrong
window.addEventListener('DOMContentLoaded', function() {
    // Bind fallback faction selection handlers immediately
    var factionCards = document.querySelectorAll('.faction-card');
    var continueBtn = document.getElementById('continue-btn');
    var selectedFaction = null;

    factionCards.forEach(function(card) {
        card.addEventListener('click', function() {
            factionCards.forEach(function(c) { c.classList.remove('selected'); });
            card.classList.add('selected');
            selectedFaction = card.dataset.faction;
            if (continueBtn) continueBtn.classList.remove('hidden');
            console.log('Fallback: Selected faction', selectedFaction);
        });
    });

    // Fallback continue button handler
    if (continueBtn) {
        continueBtn.addEventListener('click', function() {
            console.log('Fallback: Continue clicked, faction:', selectedFaction);
            // Check if game module loaded and has startGame function
            if (window.game && typeof window.game.startGame === 'function') {
                window.game.startGame(selectedFaction);
            } else {
                console.error('Game module not loaded yet');
                alert('Game is still loading. Please wait a moment and try again, or refresh the page.');
            }
        });
    }

    setTimeout(function() {
        var loading = document.getElementById('loading-screen');
        if (loading && !loading.classList.contains('hidden')) {
            console.warn('Loading timeout - module may have failed to load');
            loading.classList.add('hidden');
            var faction = document.getElementById('faction-screen');
            if (faction) faction.classList.remove('hidden');
        }
    }, 15000); // 15 second fallback - only triggers if module truly fails
});
</script>

<script type="module" src="js/main.js"></script>

</body>
</html>
